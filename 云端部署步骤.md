这份文档专为 DevOps 初学者设计，旨在带你从本地 MacBook 开发环境平滑迁移到腾讯云。

---

# 腾讯云 Web3 微服务部署全指南

## 第一部分：单服务器部署（入门级 - Docker 虚拟内网）

**适用场景**：项目初期、Demo 演示、低预算环境。所有服务（Nacos, A, B）挤在一台云服务器上。

### 1. 准备云服务器 (CVM)
*   **配置推荐**：2核 4G（Nacos 运行在 JVM 上，2G 内存非常容易导致 OOM 崩溃）。
*   **镜像选择**：Ubuntu 22.04 LTS。
*   **安全组设置**：
    *   入站允许：`22` (SSH), `8848` (Nacos控制台), `9848` (Nacos gRPC)。
    *   **安全建议**：将 8848/9848 的来源仅设为你的办公/家里公网 IP。

### 2. 服务器基础环境安装
登录服务器后执行：
```bash
# 更新并安装 Docker
curl -fsSL https://get.docker.com | bash -s docker
sudo systemctl start docker && sudo systemctl enable docker

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 3. 代码迁移与构建
1.  **上传代码**：推荐使用 GitHub 私有仓库，在服务器上 `git clone`。
2.  **环境变量**：创建 `.env` 文件，填入你的 Alchemy Key 等信息。
3.  **一键启动**：
    ```bash
    # 使用你之前写的 Makefile
    make up
    ```
    **原理**：此时 Nacos 地址在代码里写的是 `nacos:8848`。Docker 会自动创建一个虚拟网桥（Bridge），Service A 和 B 都在这个虚拟网圈里，通过“容器名”互寻。

---

## 第二部分：云局域网部署（进阶级 - 多台服务器 VPC 通信）

**适用场景**：正式项目、高并发。将 Nacos、Service A、Service B 分散到不同的云服务器上，防止“一挂全挂”。

### 1. 核心概念：VPC（虚拟私有云）
在多机模式下，Docker 虚拟网桥无法跨机器工作。我们要利用腾讯云的 **VPC 内网 IP**（通常是 `172.16.x.x` 或 `10.0.x.x`）。

### 2. 服务器角色分配
*   **Server 1 (Nacos)**: 私有 IP `172.16.0.10`
*   **Server 2 (Service B)**: 私有 IP `172.16.0.11`
*   **Server 3 (Service A)**: 私有 IP `172.16.0.12`

### 3. 关键：修改 Service B 的注册代码
在单机版中，B 注册的 IP 是 `"service_b"`。但在多机版中，B 必须告诉 Nacos 它的**真实内网 IP**。

**修改 `service_b/main.go`（增加动态获取 IP）：**
```go
func getInternalIP() string {
    addrs, _ := net.InterfaceAddrs()
    for _, addr := range addrs {
        if ipnet, ok := addr.(*net.IPNet); ok && !ipnet.IP.IsLoopback() {
            if ipnet.IP.To4() != nil {
                return ipnet.IP.String() // 获取如 172.16.0.11
            }
        }
    }
    return "127.0.0.1"
}

// 在 RegisterInstance 时
realIP := getInternalIP()
namingClient.RegisterInstance(vo.RegisterInstanceParam{
    Ip:          realIP, // 注册到 Nacos 的是真实局域网 IP
    Port:        8081,
    ServiceName: "risk-service",
    // ...
})
```

### 4. 调整 Docker 部署方式
在多机环境下，每个服务只需要跑自己的部分，不再需要全家桶式的 `docker-compose`。

**Server 1 (Nacos)**：
直接运行 `docker run -d --name nacos -p 8848:8848 -p 9848:9848 nacos/nacos-server:v2.3.1-slim`。

**Server 2 (Service B)**：
修改 `docker-compose.yml`，**必须使用 `network_mode: host`** 或者通过端口映射。
```yaml
services:
  service_b:
    build: .
    network_mode: "host" # 让容器直接使用服务器的内网 IP
    environment:
      - NACOS_ADDR=172.16.0.10 # 指向 Server 1 的 IP
```

**Server 3 (Service A)**：
```yaml
services:
  service_a:
    build: .
    network_mode: "host"
    environment:
      - NACOS_ADDR=172.16.0.10
```

### 5. 安全组配置（多机互信）
在腾讯云控制台，为这三台服务器设置一个共同的安全组规则：
*   **放通内网所有端口**：设置协议为 `ALL`，来源为 `172.16.0.0/16`（你的 VPC 网段）。
*   **这样 A 才能拨通 B 的 8081 端口。**

---

## 给 DevOps 小白的避坑指南 (Checklist)

1.  **端口偏移量 (Nacos 2.0 特色)**：
    当你开启了 8848 端口，**必须同时开启 9848 端口**。gRPC 的注册请求走的是 9848。如果 9848 不通，你会发现能进后台，但服务死活注册不上。
2.  **不要在 Mac 上编译**：
    永远在云服务器执行 `make up` 或 `docker build`。
3.  **Nacos 内存监控**：
    如果服务器经常失联，执行 `free -m` 看看内存。如果剩余不足 500MB，请立即升级服务器或配置 Swap。
4.  **注册 IP 检查**：
    如果 Service A 报错 `Connect Failed`，去 Nacos 后台看 `risk-service` 注册的 IP 是什么。如果显示的是 `172.18.x.x`（Docker默认网段），说明 B 没改代码，还是注册的容器 IP，导致 A 在外网找不着。

### 总结
*   **第一部分（单机）**：利用 Docker 容器名互相发现，最简单，适合起步。
*   **第二部分（多机）**：利用云局域网真实 IP 发现，最专业，适合上生产。

**你现在已经拿到了从“业务码农”到“架构部署”的完整地图。建议先在单机上跑通，体会一下 Nacos 后台出现服务的那一刻！**